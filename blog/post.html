<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Blogginnlegg – Attolloo Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../style.css?v=7" />
  <style>
    #post-excerpt{ font-style:italic; opacity:.9; margin:.25rem 0 1rem; }
    .card_media{ display:none; margin:.75rem 0 1rem; border-radius:.6rem; overflow:hidden; }
    .card_media img{ width:100%; height:auto; object-fit:cover; max-height:360px; display:block; }
    .post-content p{ margin:.75rem 0; }
  </style>
</head>
<body data-page="blog-post">
  <header class="site-header">
    <div class="container">
      <a class="site-logo" href="../index.html" aria-label="Til forsiden">
        <img src="../aab-logo.png" alt="Attolloo logo" />
      </a>
      <span class="site-brand-text">Attolloo Group</span>
      <nav class="main-nav" aria-label="Hovedmeny">
        <ul>
          <li><a href="../index.html">Forside</a></li>
          <li><a href="../about.html">Om oss</a></li>
          <li><a href="../services.html">Tjenester</a></li>
          <li><a href="index.html" aria-current="page">Blogg</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="page-top-space"></div>

  <main class="container">
    <section class="section">
      <h1 id="post-title" class="page-title">Laster …</h1>
      <div id="post-date" class="muted"></div>
      <p id="post-excerpt" class="muted" style="display:none"></p>

      <div class="card" style="overflow:visible">
        <div class="card_media"><img id="post-cover" src="" alt=""></div>
        <div class="card_body">
          <div id="post-content" class="card_text post-content">(Ingen innhold)</div>
        </div>
      </div>

      <p style="margin-top:1.25rem"><a class="btn-link" href="index.html">← Tilbake til bloggen</a></p>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; <span id="year"></span> Attolloogroup.</p>
    </div>
  </footer>

  <script>
  // Footer-år
  document.getElementById('year').textContent = new Date().getFullYear();

  // Enkle markdown/frontmatter-hjelpere
  function splitFrontmatter(text){
    if(typeof text !== 'string') return { attrs:{}, body:'' };
    const m = text.match(/^---\s*([\s\S]*?)\s*---\s*([\s\S]*)$/);
    if(!m) return { attrs:{}, body:text.trim() };
    const attrs = {};
    m[1].split(/\r?\n/).forEach(line=>{
      const mm = line.match(/^(\w+)\s*:\s*(.+)$/);
      if(mm) attrs[mm[1]] = mm[2];
    });
    return { attrs, body: m[2].trim() };
  }
  function mdToHTML(md){
    if(!md) return '';
    // veldig enkel: **bold**, *italic*, paragrafer
    md = md.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
           .replace(/\*(.+?)\*/g,'<em>$1</em>');
    return md.split(/\n\s*\n/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
  }
  function fmtDate(dstr, long=false){
    const d = new Date(String(dstr).slice(0,10)+'T00:00:00');
    if(isNaN(d)) return dstr || '';
    return d.toLocaleDateString('no-NO', long
      ? { weekday:'long', day:'2-digit', month:'long', year:'numeric' }
      : { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
  }

  const slug = new URLSearchParams(location.search).get('p');

  (async function loadPost(){
    const titleEl   = document.getElementById('post-title');
    const dateEl    = document.getElementById('post-date');
    const excerptEl = document.getElementById('post-excerpt');
    const coverWrap = document.querySelector('.card_media');
    const coverEl   = document.getElementById('post-cover');
    const bodyEl    = document.getElementById('post-content');

    if(!slug){ titleEl.textContent = 'Fant ikke innlegget'; return; }

    try {
      // 1) Metadata fra posts.json (tittel, cover, excerpt, date)
      let meta = null;
      try{
        const r = await fetch('posts.json?v='+Date.now(), {cache:'no-store'});
        const arr = await r.json();
        meta = Array.isArray(arr) ? arr.find(p=>p.slug===slug) : null;
      }catch(_){}

      // 2) Alltid hent selve markdown-filen for innhold
      let md = '';
      let fm = {};
      try{
        const r2 = await fetch('posts/'+slug+'.md?v='+Date.now(), {cache:'no-store'});
        if(r2.ok){
          const raw = await r2.text();
          const {attrs, body} = splitFrontmatter(raw);
          fm = attrs || {};
          md = body || '';
        }
      }catch(_){}

      // Tittel (metadata -> frontmatter -> fallback)
      const title = (meta && meta.title) || fm.title || 'Uten tittel';
      titleEl.textContent = title;

      // Dato (metadata -> frontmatter)
      const date = (meta && meta.date) || fm.date || '';
      dateEl.textContent = date ? fmtDate(date, true) : '';

      // Ingress (kursiv)
      const excerpt = (meta && meta.excerpt) || fm.excerpt || '';
      if(excerpt && String(excerpt).trim()){
        excerptEl.textContent = String(excerpt).trim();
        excerptEl.style.display = '';
      }else{
        excerptEl.style.display = 'none';
      }

      // Cover-bilde (metadata -> frontmatter)
      const cover = (meta && meta.cover) || fm.cover || '';
      if(cover){
        coverEl.src = cover;
        coverEl.alt = 'Cover: ' + title;
        coverWrap.style.display = 'block';
      } else {
        coverWrap.style.display = 'none';
      }

      // Innhold fra markdown
      bodyEl.innerHTML = md ? mdToHTML(md) : '<p>(Ingen innhold)</p>';

    } catch (e){
      console.error(e);
      titleEl.textContent = 'Feil: kunne ikke laste blogginnlegg.';
      dateEl.textContent = '';
      excerptEl.style.display = 'none';
      coverWrap.style.display = 'none';
      bodyEl.innerHTML = '<p>(Ingen innhold)</p>';
    }
  })();
  </script>
</body>
</html>
