<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Blogginnlegg – Attolloo Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style.css?v=8">
</head>
<body data-page="blog-post">

<header class="site-header">
  <div class="container">
    <a class="site-logo" href="../index.html"><img src="../aab-logo.png" alt="Attolloo logo"></a>
    <span class="site-brand-text">Attolloo Group</span>
    <nav class="main-nav">
      <ul>
        <li><a href="../index.html">Forside</a></li>
        <li><a href="../about.html">Om oss</a></li>
        <li><a href="../services.html">Tjenester</a></li>
        <li><a href="index.html">Blogg</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="page-top-space"></div>

<main class="container">
  <article class="post">
    <h1 id="post-title">Laster …</h1>
    <p id="post-date"></p>
    <img id="post-cover" class="small-cover" src="" alt="" style="display:none">
    <div id="post-content"></div>
  </article>
  <p><a href="index.html">← Tilbake til bloggen</a></p>
</main>

<footer class="container">
  <p>&copy; <span id="year"></span> Attolloogroup.</p>
</footer>
<script>
  // ©-årstall
  document.getElementById('year').textContent = new Date().getFullYear();

  // Enkelt: gjør ren tekst til paragrafer
  function simpleTextToHTML(txt){
    if(!txt) return '';
    return String(txt)
      .split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
  }

  // Plukk ut innhold uansett feltnavn/struktur vi får fra CMS
  function pickContent(post){
    if (!post || typeof post !== 'object') return '';

    // Vanlige feltnavn vi støtter først
    const direct =
      post.content_html || post.html ||
      post.content      || post.body ||
      post.markdown     || post.text;

    if (typeof direct === 'string' && direct.trim()) return direct;

    // Noen CMS lagrer riktekst i arrays (blocks, paragraphs, sections)
    const pullText = (arr) =>
      Array.isArray(arr)
        ? arr
            .map(b => (b && (b.html || b.text || b.body)) || (typeof b === 'string' ? b : ''))
            .filter(Boolean)
            .join('\n\n')
        : '';

    let parts = pullText(post.blocks);
    if (parts) return parts;
    parts = pullText(post.paragraphs);
    if (parts) return parts;
    parts = pullText(post.sections);
    if (parts) return parts;

    // Siste fallback: finn lange tekststrenger hvor som helst i objektet
    const seen = new Set();
    const out = [];
    function scan(obj){
      if(!obj || typeof obj !== 'object' || seen.has(obj)) return;
      seen.add(obj);
      for (const v of Object.values(obj)){
        if (typeof v === 'string' && v.trim().length > 40) out.push(v);
        else if (Array.isArray(v)) v.forEach(scan);
        else if (typeof v === 'object') scan(v);
      }
    }
    scan(post);
    return out.join('\n\n');
  }

  // Hent slug (?p=) og last innlegget
  (async function loadPost(){
    const params = new URLSearchParams(location.search);
    const slug   = params.get('p');

    const titleEl = document.getElementById('post-title');
    const dateEl  = document.getElementById('post-date');
    const coverEl = document.getElementById('post-cover');
    const bodyEl  = document.getElementById('post-content');
    const coverWrap = coverEl.parentElement;

    if(!slug){
      titleEl.textContent = 'Fant ikke innlegget';
      return;
    }

    try {
      const res   = await fetch('posts.json?v=' + Date.now(), { cache: 'no-store' });
      const posts = await res.json();
      const post  = Array.isArray(posts) ? posts.find(p => p.slug === slug) : null;

      if(!post){
        titleEl.textContent = 'Innlegget finnes ikke';
        return;
      }

      // Tittel og dato
      titleEl.textContent = post.title || 'Uten tittel';
      if (post.date){
        const d = new Date(post.date);
        dateEl.textContent = isNaN(d) ? post.date : d.toLocaleDateString('no-NO', { weekday:'short', year:'numeric', month:'short', day:'2-digit' });
      } else {
        dateEl.textContent = '';
      }

      // Cover-bilde (valgfritt)
      if (post.cover){
        coverEl.src = post.cover;
        coverEl.alt = post.title ? `Cover: ${post.title}` : '';
        coverWrap.style.display = 'block';
      } else {
        coverWrap.style.display = 'none';
      }

      // Innhold
      const raw = pickContent(post);
      if (raw && /<\s*[a-z][\s\S]*>/i.test(raw)) {
        bodyEl.innerHTML = raw;            // allerede HTML
      } else if (raw) {
        bodyEl.innerHTML = simpleTextToHTML(raw); // plain text -> <p>
      } else {
        bodyEl.innerHTML = '<p>(Ingen innhold)</p>';
      }

    } catch (e) {
      console.error(e);
      titleEl.textContent = 'Feil: kunne ikke laste blogginnlegg.';
    }
  })();
</script>


</body>
</html>
