<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Blogginnlegg – Attolloo Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style.css?v=8">
</head>
<body data-page="blog-post">

<header class="site-header">
  <div class="container">
    <a class="site-logo" href="../index.html"><img src="../aab-logo.png" alt="Attolloo logo"></a>
    <span class="site-brand-text">Attolloo Group</span>
    <nav class="main-nav">
      <ul>
        <li><a href="../index.html">Forside</a></li>
        <li><a href="../about.html">Om oss</a></li>
        <li><a href="../services.html">Tjenester</a></li>
        <li><a href="index.html">Blogg</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="page-top-space"></div>

<main class="container">
  <article class="post">
    <h1 id="post-title">Laster …</h1>
    <p id="post-date"></p>
    <img id="post-cover" class="small-cover" src="" alt="" style="display:none">
    <div id="post-content"></div>
  </article>
  <p><a href="index.html">← Tilbake til bloggen</a></p>
</main>

<footer class="container">
  <p>&copy; <span id="year"></span> Attolloogroup.</p>
</footer>
<script>
  // ©-år
  document.getElementById('year').textContent = new Date().getFullYear();

  // Enkelt: ren tekst -> <p>
  function simpleTextToHTML(txt){
    if(!txt) return '';
    return String(txt).split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
  }

  // Velg hovedinnhold – prioriter "INNHOLD", aldri bruk excerpt
  function pickContent(post){
    if (!post || typeof post !== 'object') return '';

    // PRIORITET: body > content_html > html > content > markdown > text
    const bodyFirst =
      post.body_html || post.body ||
      post.content_html || post.html ||
      post.content || post.markdown || post.text;

    if (typeof bodyFirst === 'string' && bodyFirst.trim()) return bodyFirst;

    // Arrays (blocks/paragraphs/sections) – slå sammen tekster
    const joinTexts = (arr) =>
      Array.isArray(arr)
        ? arr.map(b => (b && (b.html || b.text || b.body)) || (typeof b==='string'? b : ''))
             .filter(Boolean).join('\n\n')
        : '';

    let parts = joinTexts(post.blocks);     if (parts) return parts;
    parts     = joinTexts(post.paragraphs); if (parts) return parts;
    parts     = joinTexts(post.sections);   if (parts) return parts;

    // Siste fallback: plukk lange tekststrenger hvor som helst (MEN IKKE excerpt)
    const seen = new Set(), out = [];
    (function scan(o){
      if(!o || typeof o!=='object' || seen.has(o)) return;
      seen.add(o);
      for (const [k,v] of Object.entries(o)){
        if (k === 'excerpt') continue; // ikke ingress
        if (typeof v === 'string' && v.trim().length > 40) out.push(v);
        else if (Array.isArray(v)) v.forEach(scan);
        else if (typeof v === 'object') scan(v);
      }
    })(post);
    return out.join('\n\n');
  }

  (async function loadPost(){
    const params   = new URLSearchParams(location.search);
    const slug     = params.get('p');

    const titleEl  = document.getElementById('post-title');
    const dateEl   = document.getElementById('post-date');
    const coverEl  = document.getElementById('post-cover');
    const bodyEl   = document.getElementById('post-content');
    const coverWrap= coverEl.parentElement;

    if(!slug){ titleEl.textContent = 'Fant ikke innlegget'; return; }

    try {
      const res   = await fetch('posts.json?v='+Date.now(), { cache:'no-store' });
      const posts = await res.json();
      const post  = Array.isArray(posts) ? posts.find(p => p.slug === slug) : null;

      if(!post){ titleEl.textContent = 'Innlegget finnes ikke'; return; }

      // Tittel & dato
      titleEl.textContent = post.title || 'Uten tittel';
      if (post.date){
        const d = new Date(post.date);
        dateEl.textContent = isNaN(d) ? post.date : d.toLocaleDateString('no-NO', { weekday:'short', year:'numeric', month:'short', day:'2-digit' });
      } else { dateEl.textContent = ''; }

      // Cover-bilde – støtt flere nøkler
      const cover =
        post.cover || post.image || post.hero_image ||
        (post.media && (post.media.cover || post.media.image)) || null;

      if (cover){
        coverEl.src = cover;
        coverEl.alt = post.title ? `Cover: ${post.title}` : '';
        coverWrap.style.display = 'block';
      } else {
        coverWrap.style.display = 'none';
      }

      // Innhold (ikke ingress)
      const raw = pickContent(post);
      if (raw && /<\s*[a-z][\s\S]*>/i.test(raw)) bodyEl.innerHTML = raw;
      else if (raw) bodyEl.innerHTML = simpleTextToHTML(raw);
      else bodyEl.innerHTML = '<p>(Ingen innhold)</p>';

    } catch (e) {
      console.error(e);
      titleEl.textContent = 'Feil: kunne ikke laste blogginnlegg.';
    }
  })();
</script>


</body>
</html>
